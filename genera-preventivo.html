<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generatore Preventivi - 3DMAKES</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .sidebar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .sidebar h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f58220;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
            font-size: 13px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .btn {
            background: #f58220;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #d67019;
            transform: translateY(-1px);
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .btn-danger {
            background: #e74c3c;
            padding: 6px 12px;
            font-size: 12px;
            margin-top: 0;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-add {
            background: #3498db;
            padding: 8px 15px;
            font-size: 13px;
            width: auto;
            display: inline-block;
        }

        .btn-add:hover {
            background: #2980b9;
        }

        .preview-container {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .preview {
            background: white;
            max-width: 210mm;
            margin: 0 auto;
            padding: 40px;
            border: 1px solid #ddd;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        .company-info {
            flex: 1;
        }

        .company-logo {
            max-width: 150px;
            max-height: 80px;
            margin-bottom: 15px;
            object-fit: contain;
        }

        .company-name {
            font-size: 24px;
            font-weight: bold;
            color: #4a90e2;
            margin-bottom: 10px;
        }

        .company-details {
            font-size: 12px;
            line-height: 1.6;
            color: #666;
        }

        .client-info {
            text-align: right;
            font-size: 14px;
            line-height: 1.6;
        }

        .client-name {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .document-title {
            text-align: center;
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin: 30px 0;
            text-transform: uppercase;
        }

        .document-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            font-size: 13px;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 30px 0;
        }

        .items-table th {
            background: #333;
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .items-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #ddd;
            font-size: 13px;
        }

        .items-table tr:last-child td {
            border-bottom: 2px solid #333;
        }

        .total-section {
            margin-top: 20px;
            text-align: right;
        }

        .total-row {
            display: flex;
            justify-content: flex-end;
            gap: 20px;
            margin: 10px 0;
            font-size: 14px;
        }

        .total-row.final {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 2px solid #333;
        }

        .notes {
            margin-top: 40px;
            padding: 20px;
            background: #f9f9f9;
            border-left: 4px solid #f58220;
            font-size: 12px;
            line-height: 1.8;
        }

        .notes strong {
            display: block;
            margin-bottom: 10px;
            color: #333;
        }

        .footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
            text-align: center;
            font-size: 11px;
            color: #999;
        }

        .editable-table {
            margin-top: 20px;
        }

        .table-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .table-row input {
            flex: 1;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }

        .table-row input.small {
            flex: 0 0 60px;
        }

        .section-title {
            font-weight: bold;
            color: #f58220;
            margin: 20px 0 10px 0;
            font-size: 14px;
        }

        @media (max-width: 1024px) {
            .container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .sidebar {
                position: relative;
                top: 0;
                margin-bottom: 20px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }

            .container {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .sidebar {
                padding: 15px;
            }

            .preview {
                padding: 20px;
            }

            .header {
                flex-direction: column;
                align-items: flex-start;
            }

            .client-info {
                text-align: left;
                margin-top: 15px;
            }

            .company-logo {
                max-width: 120px;
                max-height: 60px;
            }

            .items-table {
                font-size: 11px;
            }

            .items-table th,
            .items-table td {
                padding: 8px 4px;
            }

            .document-title {
                font-size: 20px;
            }

            .total-section {
                font-size: 12px;
            }

            .total-row.final {
                font-size: 16px;
            }

            .form-group label {
                font-size: 12px;
            }

            .form-group input,
            .form-group textarea,
            .form-group select {
                font-size: 13px;
                padding: 6px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 13px;
            }

            .section-title {
                font-size: 13px;
            }

            .table-row {
                flex-direction: column;
                gap: 5px;
            }

            .table-row input {
                width: 100%;
            }

            .notes {
                font-size: 11px;
                padding: 15px;
            }
        }

        @media print {
            .sidebar,
            .btn {
                display: none;
            }
            
            .container {
                grid-template-columns: 1fr;
            }
            
            .preview {
                border: none;
                box-shadow: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- SIDEBAR EDITOR -->
        <div class="sidebar">
            <h2>‚öôÔ∏è Editor Preventivo</h2>

            <div class="section-title">üìÑ Info Documento</div>
            
            <div class="form-group">
                <label>Numero Offerta:</label>
                <input type="text" id="numeroOfferta" value="Caricamento..." oninput="aggiorna()" readonly style="background: #f0f0f0;">
                <small style="color: #666; font-size: 11px; margin-top: 5px; display: block;">
                    ‚ö° Numero generato automaticamente e sequenziale
                </small>
            </div>

            <div class="form-group">
                <label>Data:</label>
                <input type="date" id="dataDoc" oninput="aggiorna()">
            </div>

            <div class="section-title">üë§ Dati Cliente</div>
            <div class="form-group">
                <label>Nome Cliente:</label>
                <input type="text" id="nomeCliente" value="Mario Rossi" oninput="aggiorna()">
            </div>

            <div class="form-group">
                <label>Indirizzo Cliente:</label>
                <textarea id="indirizzoCliente" oninput="aggiorna()">Via Roma 123
6900 Lugano
Svizzera</textarea>
            </div>

            <div class="section-title">üìã Articoli</div>
            <button class="btn btn-add" onclick="aggiungiRiga()">+ Aggiungi Riga</button>
            
            <div id="righeEditor"></div>

            <div class="section-title">üí¨ Note & Condizioni</div>
            <div class="form-group">
                <label>Note:</label>
                <textarea id="note" oninput="aggiorna()">Prezzo: IVA esclusa (regime forfettario)
Termine: 15 giorni lavorativi dall'ordinazione
Pagamento: 30 giorni netto dalla ricezione della merce</textarea>
            </div>

            <button class="btn btn-success" onclick="scaricaPDF()">üì• Scarica PDF</button>
            <button class="btn" onclick="stampa()">üñ®Ô∏è Stampa</button>
            <a href="storico-preventivi.html" class="btn" style="text-align: center; text-decoration: none; display: block; background: #3498db;">üìã Storico Preventivi</a>
        </div>

        <!-- PREVIEW -->
        <div class="preview-container">
            <div class="preview" id="preventivo">
                <div class="header">
                    <div class="company-info">
                        <img src="./logo.png" alt="3DMAKES Logo" class="company-logo" id="prev-logo" onerror="this.style.display='none';">
                        <div class="company-details">
                            <div style="white-space: pre-line;" id="prev-indirizzoAzienda"></div>
                            <div style="white-space: pre-line; margin-top: 10px;" id="prev-contattiAzienda"></div>
                        </div>
                    </div>
                    <div class="client-info">
                        <div class="client-name" id="prev-nomeCliente">Mario Rossi</div>
                        <div style="white-space: pre-line;" id="prev-indirizzoCliente"></div>
                    </div>
                </div>

                <div class="document-title">Offerta</div>

                <div class="document-info">
                    <div>
                        <strong>Offerta:</strong> <span id="prev-numeroOfferta">2024/001</span>
                    </div>
                    <div>
                        <strong>Data:</strong> <span id="prev-data"></span>
                    </div>
                </div>

                <table class="items-table" id="prev-table">
                    <thead>
                        <tr>
                            <th style="width: 8%;">Art.</th>
                            <th style="width: 42%;">Descrizione</th>
                            <th style="width: 10%;">Quantit√†</th>
                            <th style="width: 15%;">Prezzo unit.</th>
                            <th style="width: 10%;">Sconto</th>
                            <th style="width: 15%;">Importo</th>
                        </tr>
                    </thead>
                    <tbody id="prev-tbody">
                    </tbody>
                </table>

                <div class="total-section">
                    <div class="total-row final">
                        <strong>TOTALE:</strong>
                        <span id="prev-totale">0.00 CHF</span>
                    </div>
                </div>

                <div class="notes">
                    <strong>Note e Condizioni:</strong>
                    <div style="white-space: pre-line;" id="prev-note"></div>
                </div>

                <div class="footer">
                    Preventivo generato da 3DMAKES
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURAZIONE FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyAOpvFiXTvDuMKXEU1dymj_wYdhSmS6MFc",
            authDomain: "preventivi-9fee1.firebaseapp.com",
            projectId: "preventivi-9fee1",
            storageBucket: "preventivi-9fee1.firebasestorage.app",
            messagingSenderId: "381883404247",
            appId: "1:381883404247:web:befceff98b2d21a1a70592"
        };

        let db = null;
        let firebaseInitialized = false;

        // Inizializza Firebase
        try {
            if (firebaseConfig.apiKey !== "YOUR_API_KEY") {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('‚úÖ Firebase inizializzato correttamente');
            } else {
                console.warn('‚ö†Ô∏è Firebase non configurato. Inserisci le credenziali nel codice.');
            }
        } catch (error) {
            console.error('‚ùå Errore inizializzazione Firebase:', error);
        }

        // ============================================
        // FUNZIONI FIRESTORE
        // ============================================

        // Ottiene il prossimo numero sequenziale per i preventivi
        async function ottieniProssimoNumeroPreventivo() {
            if (!firebaseInitialized) {
                console.warn('Firebase non inizializzato, uso numero manuale');
                return document.getElementById('numeroOfferta').value;
            }

            try {
                const anno = new Date().getFullYear();
                const counterRef = db.collection('counters').doc('preventivi');
                
                // Usa una transazione per garantire numeri sequenziali univoci
                const nuovoNumero = await db.runTransaction(async (transaction) => {
                    const counterDoc = await transaction.get(counterRef);
                    
                    let counter = 1;
                    let currentYear = anno;
                    
                    if (counterDoc.exists) {
                        const data = counterDoc.data();
                        currentYear = data.year || anno;
                        
                        // Se √® un nuovo anno, ricomincia da 1
                        if (currentYear !== anno) {
                            counter = 1;
                            currentYear = anno;
                        } else {
                            counter = (data.counter || 0) + 1;
                        }
                    }
                    
                    // Aggiorna il contatore
                    transaction.set(counterRef, {
                        counter: counter,
                        year: currentYear,
                        lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    return `${anno}/${String(counter).padStart(3, '0')}`;
                });
                
                return nuovoNumero;
            } catch (error) {
                console.error('Errore ottenimento numero preventivo:', error);
                throw error;
            }
        }

        // Salva il preventivo in Firestore
        async function salvaPreventivoFirestore(datiPreventivo) {
            if (!firebaseInitialized) {
                console.warn('Firebase non inizializzato, salvataggio saltato');
                return null;
            }

            try {
                const docRef = await db.collection('preventivi').add({
                    ...datiPreventivo,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                console.log('‚úÖ Preventivo salvato con ID:', docRef.id);
                return docRef.id;
            } catch (error) {
                console.error('‚ùå Errore salvataggio preventivo:', error);
                throw error;
            }
        }

        // ============================================
        // DATI PREVENTIVO
        // ============================================
        
        // Dati delle righe
        let righe = [
            {
                articolo: '1',
                descrizione: 'Stampa 3D in PLA\nModello personalizzato',
                quantita: 1,
                prezzoUnit: 50.00,
                sconto: 0
            },
            {
                articolo: '2',
                descrizione: 'Post-processing e finitura',
                quantita: 1,
                prezzoUnit: 25.00,
                sconto: 0
            }
        ];

        // Inizializza la data di oggi
        document.getElementById('dataDoc').valueAsDate = new Date();

        // ============================================
        // FUNZIONI NUMERO PREVENTIVO
        // ============================================

        // Carica automaticamente il prossimo numero preventivo all'avvio
        async function caricaProssimoNumeroPreventivo() {
            try {
                const nuovoNumero = await ottieniProssimoNumeroPreventivo();
                document.getElementById('numeroOfferta').value = nuovoNumero;
                aggiorna();
            } catch (error) {
                console.error('Errore nel caricamento del numero preventivo:', error);
                // Se c'√® un errore, usa un numero di default basato sulla data
                const anno = new Date().getFullYear();
                document.getElementById('numeroOfferta').value = `${anno}/001`;
                aggiorna();
            }
        }

        // Prepara i dati del preventivo per il salvataggio
        function preparaDatiPreventivo() {
            const totale = calcolaTotale();
            
            return {
                numeroOfferta: document.getElementById('numeroOfferta').value,
                data: document.getElementById('dataDoc').value,
                cliente: {
                    nome: document.getElementById('nomeCliente').value,
                    indirizzo: document.getElementById('indirizzoCliente').value
                },
                righe: righe.map(riga => ({
                    articolo: riga.articolo,
                    descrizione: riga.descrizione,
                    quantita: riga.quantita,
                    prezzoUnit: riga.prezzoUnit,
                    sconto: riga.sconto,
                    importo: (riga.quantita * riga.prezzoUnit) * (1 - riga.sconto / 100)
                })),
                note: document.getElementById('note').value,
                totale: totale,
                valuta: 'CHF'
            };
        }

        // Calcola il totale del preventivo
        function calcolaTotale() {
            let totale = 0;
            righe.forEach(riga => {
                const importoSenzaSconto = riga.quantita * riga.prezzoUnit;
                const importoSconto = importoSenzaSconto * (riga.sconto / 100);
                const importo = importoSenzaSconto - importoSconto;
                totale += importo;
            });
            return totale;
        }

        // ============================================
        // FUNZIONI GESTIONE RIGHE
        // ============================================

        // Funzione per aggiungere una nuova riga
        function aggiungiRiga() {
            righe.push({
                articolo: (righe.length + 1).toString(),
                descrizione: 'Nuova voce',
                quantita: 1,
                prezzoUnit: 0,
                sconto: 0
            });
            renderEditor();
            aggiorna();
        }

        // Funzione per rimuovere una riga
        function rimuoviRiga(index) {
            if (righe.length > 1) {
                righe.splice(index, 1);
                // Rinumera articoli
                righe.forEach((riga, i) => {
                    riga.articolo = (i + 1).toString();
                });
                renderEditor();
                aggiorna();
            } else {
                alert('Devi mantenere almeno una riga!');
            }
        }

        // Funzione per aggiornare i dati di una riga
        function aggiornaRiga(index, campo, valore) {
            righe[index][campo] = valore;
            aggiorna();
        }

        // Render dell'editor delle righe
        function renderEditor() {
            const container = document.getElementById('righeEditor');
            container.innerHTML = '';

            righe.forEach((riga, index) => {
                const rigaDiv = document.createElement('div');
                rigaDiv.style.cssText = 'background: #f9f9f9; padding: 15px; margin: 10px 0; border-radius: 6px; border: 1px solid #ddd;';
                
                rigaDiv.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #333;">Riga ${index + 1}</strong>
                        <button class="btn btn-danger" onclick="rimuoviRiga(${index})">üóëÔ∏è Elimina</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Articolo:</label>
                        <input type="text" value="${riga.articolo}" 
                            onchange="aggiornaRiga(${index}, 'articolo', this.value)">
                    </div>
                    
                    <div class="form-group">
                        <label>Descrizione:</label>
                        <textarea onchange="aggiornaRiga(${index}, 'descrizione', this.value)">${riga.descrizione}</textarea>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div class="form-group">
                            <label>Quantit√†:</label>
                            <input type="number" value="${riga.quantita}" min="1" step="1"
                                onchange="aggiornaRiga(${index}, 'quantita', parseFloat(this.value))">
                        </div>
                        
                        <div class="form-group">
                            <label>Prezzo Unit. (CHF):</label>
                            <input type="number" value="${riga.prezzoUnit}" min="0" step="0.01"
                                onchange="aggiornaRiga(${index}, 'prezzoUnit', parseFloat(this.value))">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Sconto (%):</label>
                        <input type="number" value="${riga.sconto}" min="0" max="100" step="1"
                            onchange="aggiornaRiga(${index}, 'sconto', parseFloat(this.value))">
                    </div>
                `;
                
                container.appendChild(rigaDiv);
            });
        }

        // Funzione per aggiornare il preview
        function aggiorna() {
            // Info azienda fisse
            document.getElementById('prev-indirizzoAzienda').textContent = 'Via Cantonale 15\nCH-6918 Lugano';
            document.getElementById('prev-contattiAzienda').textContent = 'Tel: 076 266 03 96\nEmail: info@3dmakes.ch\nWeb: www.3dmakes.ch';

            // Aggiorna info cliente
            document.getElementById('prev-nomeCliente').textContent = document.getElementById('nomeCliente').value;
            document.getElementById('prev-indirizzoCliente').textContent = document.getElementById('indirizzoCliente').value;

            // Aggiorna info documento
            document.getElementById('prev-numeroOfferta').textContent = document.getElementById('numeroOfferta').value;
            const data = new Date(document.getElementById('dataDoc').value);
            document.getElementById('prev-data').textContent = data.toLocaleDateString('it-IT');

            // Aggiorna note
            document.getElementById('prev-note').textContent = document.getElementById('note').value;

            // Aggiorna tabella
            const tbody = document.getElementById('prev-tbody');
            tbody.innerHTML = '';
            
            let subtotale = 0;

            righe.forEach(riga => {
                const importoSenzaSconto = riga.quantita * riga.prezzoUnit;
                const importoSconto = importoSenzaSconto * (riga.sconto / 100);
                const importo = importoSenzaSconto - importoSconto;
                subtotale += importo;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${riga.articolo}</td>
                    <td style="white-space: pre-line;">${riga.descrizione}</td>
                    <td>${riga.quantita}</td>
                    <td>${riga.prezzoUnit.toFixed(2)} CHF</td>
                    <td>${riga.sconto > 0 ? riga.sconto + '%' : '-'}</td>
                    <td><strong>${importo.toFixed(2)} CHF</strong></td>
                `;
                tbody.appendChild(tr);
            });

            // Calcola totali (senza IVA - regime forfettario)
            const totale = subtotale;

            document.getElementById('prev-totale').textContent = totale.toFixed(2) + ' CHF';
        }

        // Funzione per scaricare PDF
        async function scaricaPDF() {
            const preventivo = document.getElementById('preventivo');
            
            // Mostra un messaggio di caricamento
            const btnPDF = event.target;
            const textOriginale = btnPDF.textContent;
            btnPDF.textContent = '‚è≥ Generazione PDF...';
            btnPDF.disabled = true;

            try {
                // Verifica che html2canvas sia disponibile
                if (typeof html2canvas === 'undefined') {
                    throw new Error('html2canvas non √® caricato. Controlla la connessione internet.');
                }

                // Usa html2canvas per catturare il preventivo
                const canvas = await html2canvas(preventivo, {
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    backgroundColor: '#ffffff'
                });

                // Crea il PDF - controlla diverse possibilit√† di caricamento
                let jsPDF;
                if (window.jspdf && window.jspdf.jsPDF) {
                    jsPDF = window.jspdf.jsPDF;
                } else if (window.jsPDF && window.jsPDF.jsPDF) {
                    jsPDF = window.jsPDF.jsPDF;
                } else if (window.jsPDF) {
                    jsPDF = window.jsPDF;
                } else {
                    throw new Error('jsPDF non √® caricato. Controlla la connessione internet.');
                }
                
                const pdf = new jsPDF('p', 'mm', 'a4');
                
                const imgWidth = 210; // A4 width in mm
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                
                const imgData = canvas.toDataURL('image/png');
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);

                // Salva il PDF
                const numeroOfferta = document.getElementById('numeroOfferta').value.replace(/\//g, '-');
                const nomeFile = `Preventivo_${numeroOfferta}_${new Date().toISOString().split('T')[0]}.pdf`;
                pdf.save(nomeFile);

                btnPDF.textContent = 'üíæ Salvataggio in Firestore...';

                // Salva il preventivo in Firestore
                try {
                    const datiPreventivo = preparaDatiPreventivo();
                    const docId = await salvaPreventivoFirestore(datiPreventivo);
                    
                    if (docId) {
                        btnPDF.textContent = '‚úÖ PDF Scaricato e Salvato!';
                        console.log('Preventivo salvato con successo in Firestore');
                    } else {
                        btnPDF.textContent = '‚úÖ PDF Scaricato (Firebase non configurato)';
                    }
                } catch (firestoreError) {
                    console.error('Errore salvataggio Firestore:', firestoreError);
                    btnPDF.textContent = '‚ö†Ô∏è PDF Scaricato (Errore salvataggio DB)';
                }

                setTimeout(() => {
                    btnPDF.textContent = textOriginale;
                    btnPDF.disabled = false;
                }, 3000);

            } catch (error) {
                console.error('Errore generazione PDF:', error);
                console.log('Disponibilit√† librerie:', {
                    html2canvas: typeof html2canvas !== 'undefined',
                    'window.jspdf': typeof window.jspdf !== 'undefined',
                    'window.jsPDF': typeof window.jsPDF !== 'undefined'
                });
                
                let messaggioErrore = '‚ùå Errore durante la generazione del PDF.\n\n';
                messaggioErrore += error.message || 'Errore sconosciuto.';
                messaggioErrore += '\n\nProva a:';
                messaggioErrore += '\n1. Ricaricare la pagina (CTRL+F5)';
                messaggioErrore += '\n2. Verificare la connessione internet';
                messaggioErrore += '\n3. Controllare la console (F12) per dettagli';
                
                alert(messaggioErrore);
                btnPDF.textContent = textOriginale;
                btnPDF.disabled = false;
            }
        }

        // Funzione per stampare
        function stampa() {
            window.print();
        }

        // Verifica caricamento librerie all'avvio
        window.addEventListener('load', function() {
            console.log('Librerie caricate:', {
                html2canvas: typeof html2canvas !== 'undefined',
                'window.jspdf': typeof window.jspdf !== 'undefined',
                'window.jsPDF': typeof window.jsPDF !== 'undefined',
                firebase: typeof firebase !== 'undefined'
            });
            
            // Carica automaticamente il prossimo numero preventivo
            caricaProssimoNumeroPreventivo();
        });

        // Inizializza
        renderEditor();
        aggiorna();
    </script>
</body>
</html>

